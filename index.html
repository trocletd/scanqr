<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Pr√©sence Simple</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        #reader {
            width: 100%;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .result {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin: 10px 0;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .stats {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .manual-input {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Scanner Pr√©sence</h1>
        
        <div id="reader"></div>
        
        <div class="manual-input">
            <h3>ou saisie manuelle :</h3>
            <input type="text" id="manualId" placeholder="Entrez l'ID ou nom">
            <button class="btn" onclick="validateManualEntry()">Valider pr√©sence</button>
        </div>
        
        <div class="stats">
            <strong>Pr√©sences du jour : <span id="todayCount">0</span></strong>
        </div>
        
        <div class="info">
            <strong>‚ö†Ô∏è Note :</strong> Les donn√©es sont stock√©es temporairement. 
            T√©l√©chargez le CSV avant de fermer l'application !
        </div>
        
        <div id="result"></div>
        
        <button class="btn" onclick="showHistory()">üìã Voir l'historique</button>
        <button class="btn" onclick="downloadCSV()">üíæ T√©l√©charger CSV</button>
    </div>

    <script>
        // Stockage en m√©moire (remplace localStorage)
        let presences = [];
        let isScanning = false;
        
        // Mettre √† jour le compteur
        function updateCounter() {
            const today = new Date().toDateString();
            const todayPresences = presences.filter(p => new Date(p.timestamp).toDateString() === today);
            document.getElementById('todayCount').textContent = todayPresences.length;
        }
        
        // Fonction de scan QR
        function onScanSuccess(decodedText) {
            if (isScanning) return; // √âviter les doublons
            isScanning = true;
            
            console.log('QR scann√©:', decodedText);
            
            let userId;
            try {
                // Essayer de parser comme JSON
                const data = JSON.parse(decodedText);
                userId = data.user_id || data.id || data.name || decodedText;
            } catch (e) {
                // Si pas JSON, utiliser directement
                userId = decodedText;
            }
            
            validatePresence(userId);
            
            // R√©activer le scan apr√®s 2 secondes
            setTimeout(() => { isScanning = false; }, 2000);
        }
        
        // Valider une pr√©sence
        function validatePresence(userId) {
            const now = new Date();
            const presence = {
                id: userId,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString('fr-FR'),
                time: now.toLocaleTimeString('fr-FR')
            };
            
            // V√©rifier si d√©j√† pr√©sent aujourd'hui
            const today = now.toDateString();
            const alreadyPresent = presences.some(p => 
                p.id === userId && new Date(p.timestamp).toDateString() === today
            );
            
            if (alreadyPresent) {
                showMessage('‚ö†Ô∏è D√©j√† marqu√© pr√©sent aujourd\'hui !', 'error');
                return;
            }
            
            // Ajouter la pr√©sence
            presences.push(presence);
            
            showMessage(`‚úÖ Pr√©sence valid√©e !<br>
                        <strong>${userId}</strong><br>
                        ${presence.date} √† ${presence.time}`, 'result');
            
            updateCounter();
        }
        
        // Saisie manuelle
        function validateManualEntry() {
            const userId = document.getElementById('manualId').value.trim();
            if (!userId) {
                showMessage('‚ùå Veuillez entrer un ID', 'error');
                return;
            }
            
            validatePresence(userId);
            document.getElementById('manualId').value = '';
        }
        
        // Afficher un message
        function showMessage(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
            
            // Faire dispara√Ætre apr√®s 5 secondes
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 5000);
        }
        
        // Afficher l'historique
        function showHistory() {
            if (presences.length === 0) {
                showMessage('üìã Aucune pr√©sence enregistr√©e', 'info');
                return;
            }
            
            const last10 = presences.slice(-10).reverse();
            let historyHTML = '<div class="info"><strong>üìã Derni√®res pr√©sences :</strong><br>';
            
            last10.forEach(p => {
                historyHTML += `‚Ä¢ ${p.id} - ${p.date} ${p.time}<br>`;
            });
            
            historyHTML += '</div>';
            document.getElementById('result').innerHTML = historyHTML;
        }
        
        // T√©l√©charger CSV
        function downloadCSV() {
            if (presences.length === 0) {
                showMessage('‚ùå Aucune donn√©e √† t√©l√©charger', 'error');
                return;
            }
            
            let csv = 'ID,Date,Heure,Timestamp\n';
            presences.forEach(p => {
                csv += `"${p.id}","${p.date}","${p.time}","${p.timestamp}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `presences_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('üíæ Fichier CSV t√©l√©charg√© !', 'result');
        }
        
        // Initialiser le scanner QR
        function initScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            
            // D'abord demander les permissions cam√©ra
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Utiliser la cam√©ra arri√®re si disponible
                    const cameraId = devices.length > 1 ? devices[1].id : devices[0].id;
                    
                    html5QrCode.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        onScanSuccess,
                        onScanFailure
                    ).catch(err => {
                        console.error('Erreur d√©marrage cam√©ra:', err);
                        showCameraError();
                    });
                } else {
                    showCameraError();
                }
            }).catch(err => {
                console.error('Erreur acc√®s cam√©ras:', err);
                showCameraError();
            });
        }
        
        function onScanFailure(error) {
            // Ne rien faire - erreurs normales de scan
        }
        
        function showCameraError() {
            document.getElementById('reader').innerHTML = 
                '<div class="error">‚ùå Cam√©ra non accessible<br>‚Ä¢ Autorisez l\'acc√®s cam√©ra<br>‚Ä¢ Utilisez HTTPS<br>‚Ä¢ Ou utilisez la saisie manuelle</div>';
        }
        
        // D√©marrer au chargement
        window.onload = function() {
            updateCounter();
            initScanner();
            
            // Message d'info
            showMessage('üì± Scannez un QR code ou utilisez la saisie manuelle', 'info');
        };
        
        // G√©rer la saisie Enter
        document.getElementById('manualId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateManualEntry();
            }
        });
    </script>
</body>
</html>